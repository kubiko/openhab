#!/bin/sh

# settings were altered by user, safest way to get them applied is to restart service

# for the moment we can't read settings outside of the hook,
# so store all settings in helpper script which is then picked by main wrapper
SETTINGS_FILE="$SNAP_COMMON/openhab_settings.sh"
# first read existing settings, as snapctl gives us only value which changed
if [ -f $SETTINGS_FILE ]; then
    HTTPS_SETTINGS=$(grep 'OPENHAB_HTTPS_PORT' $SETTINGS_FILE)
    HTTP_SETTINGS=$(grep 'OPENHAB_HTTP_PORT' $SETTINGS_FILE)
fi

echo "#!/bin/sh\n" > $SETTINGS_FILE
if pvalue=$(snapctl get OPENHAB_HTTPS_PORT); then
    echo "export OPENHAB_HTTPS_PORT=$pvalue" >> $SETTINGS_FILE
elif [ -z '$HTTPS_SETTINGS' ]; then
    echo $HTTPS_SETTINGS >> $SETTINGS_FILE
fi

if pvalue=$(snapctl get OPENHAB_HTTP_PORT); then
    echo "export OPENHAB_HTTP_PORT=$pvalue" >> $SETTINGS_FILE
elif [ -z '$HTTP_SETTINGS' ]; then
    echo $HTTP_SETTINGS >> $SETTINGS_FILE
fi

# set file executable
chmod 755 $SETTINGS_FILE

# we can't use snapctl to restart service, may be one day ....
echo "Setting has been updated, restart service. $sudo openhab.stop"
# $SNAP/command-stop.wrapper
# $SNAP/command-start.wrapper
